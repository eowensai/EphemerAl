###############################################################################
# docker-compose.yml — EphemerAl demo stack
#
# Three-service layout:
#   • ollama        — serves the LLM (GPU / CUDA)
#   • tika-server   — parses over 100 document types
#   • ephemeral-app — Streamlit front-end website
#
# CUSTOMIZE comments below flag the lines that most people tweak:
#   • LLM model name (12b vs 27b)
#   • Service / container names if you prefer different labels
###############################################################################

services:
  # --------------------------------------------------------------------------
  # Apache Tika — document parsing
  # --------------------------------------------------------------------------
  tika-server:
    image: apache/tika:3.2.3.0-full
    container_name: tika-server
    restart: unless-stopped
    networks: [llm-net]
    environment:
      - JAVA_TOOL_OPTIONS=-Xmx2g -Xms512m
    ports: ["9998:9998"]

    # Keep /tmp in RAM so uploaded docs never touch disk inside the container
    tmpfs:
      - /tmp

    # Disable Docker logs for this container (privacy)
    logging:
      driver: "none"

  # --------------------------------------------------------------------------
  # Streamlit front-end (EphemerAl)
  # --------------------------------------------------------------------------
  ephemeral-app:
    build: .                              # uses local Dockerfile
    container_name: ephemeral-app
    restart: unless-stopped
    # Use host networking so we can see the WSL /etc/resolv.conf and connect to Tika on localhost
    network_mode: "host"

    environment:
      # LLM_BASE_URL is set dynamically in the command below to point to the Windows host
      - LLM_MODEL_NAME=gemma3-prod         # CUSTOMIZE: Matches the generic name created in deployment guide
      - TIKA_URL=http://localhost:9998
      - TIKA_CLIENT_ONLY=true
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      # - EPHEMERAL_TIMEZONE=America/New_York   # CUSTOMIZE: Override system timezone (optional)

    depends_on: [tika-server]

    # Dynamically resolve Windows Host IP (nameserver) and inject it into LLM_BASE_URL
    # This is required for native WSL2 Docker to talk to Windows localhost.
    # Note: We use network_mode: host so /etc/resolv.conf is the WSL one, not Docker's.
    command: >
      /bin/sh -c "
        export WINDOWS_HOST=$$(grep nameserver /etc/resolv.conf | awk '{print $$2}');
        export LLM_BASE_URL=http://$${WINDOWS_HOST}:11434/v1;
        echo 'Pointing LLM to Windows Host at' $$LLM_BASE_URL;
        streamlit run ephemeral_app.py --server.port=8501 --server.address=0.0.0.0
      "

    # Static assets (logo, CSS) mounted read-only
    volumes:
      - ./static:/app/static:ro

    # Keep /tmp in RAM for any temporary upload buffers
    tmpfs:
      - /tmp

    # Rotated logs for debugging.
    # For a final kiosk box, you can change driver: "local" → "none".
    logging:
      driver: "local"
      options:
        max-size: "2m"
        max-file: "3"

# --------------------------------------------------------------------------
# Shared network — keeps container DNS simple (ollama, tika-server, etc.)
# --------------------------------------------------------------------------
networks:
  llm-net:
    driver: bridge

